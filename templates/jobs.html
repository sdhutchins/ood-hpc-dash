{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <br/>
        <h3 class="pb-2 mb-3 border-bottom">Cluster Partitions & Job Status</h3>
        <p class="text-muted mb-3">
            Monitor cluster resources and partition availability. Use this information to choose the best partition for your job submission.
        </p>
        <div class="mb-3">
            <a href="https://docs.rc.uab.edu/cheaha/hardware/" target="_blank" class="btn btn-sm me-2" style="background-color: var(--theme-bg-color); border-color: var(--theme-bg-color); color: var(--theme-text-color);">
                <i class="fas fa-external-link-alt me-1"></i>Hardware Documentation
            </a>
            <a href="https://docs.rc.uab.edu/cheaha/job_efficiency/" target="_blank" class="btn btn-sm" style="background-color: var(--theme-bg-color); border-color: var(--theme-bg-color); color: var(--theme-text-color);">
                <i class="fas fa-external-link-alt me-1"></i>Job Efficiency Guide
            </a>
        </div>
    </div>
</div>

{# User's Running/Queued Jobs #}
{% if username %}
<div class="row mb-4">
    <div class="col">
        <div class="card shadow-sm mb-3">
            <div class="card-header" style="background-color: var(--theme-bg-color);">
                <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>My Running/Queued Jobs</h5>
            </div>
            <div class="card-body p-0">
                {% if user_jobs_error %}
                <div class="alert alert-warning m-3 mb-0">
                    <small>Error loading jobs: {{ user_jobs_error }}</small>
                </div>
                {% elif user_jobs %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead style="background-color: var(--theme-bg-color);">
                            <tr>
                                <th>Job ID</th>
                                <th>Name</th>
                                <th>State</th>
                                <th>Partition</th>
                                <th>Time Used</th>
                                <th>Time Limit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in user_jobs %}
                            <tr>
                                <td><code>{{ job.id }}</code></td>
                                <td>{{ job.name }}</td>
                                <td>
                                    {% if job.state in ['RUNNING', 'R'] %}
                                        <span class="badge bg-success">Running</span>
                                    {% elif job.state in ['PENDING', 'PD'] %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ job.state }}</span>
                                    {% endif %}
                                </td>
                                <td><code>{{ job.partition }}</code></td>
                                <td><small>{{ job.time_used }}</small></td>
                                <td><small>{{ job.time_limit }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info m-3 mb-0">
                    <small>No running or queued jobs.</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Job History #}
<div class="row mb-4">
    <div class="col">
        <div class="card shadow-sm mb-3">
            <div class="card-header" style="background-color: var(--theme-bg-color);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Job History</h5>
                        <small class="text-muted">Showing jobs from the last 90 days</small>
                    </div>
                    <button type="button" class="btn btn-sm" id="refreshHistoryBtn" style="background-color: var(--theme-bg-color); border-color: var(--theme-bg-color); color: var(--theme-text-color);">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if history_error %}
                <div class="alert alert-warning m-3 mb-0">
                    <small>Error loading job history: {{ history_error }}</small>
                </div>
                {% elif job_history %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0" id="historyTable">
                        <thead style="background-color: var(--theme-bg-color);">
                            <tr>
                                <th>Job ID</th>
                                <th>Name</th>
                                <th>State</th>
                                <th>Partition</th>
                                <th class="sortable" data-sort="start">Start Date <i class="bi bi-arrow-down-up"></i></th>
                                <th class="sortable" data-sort="elapsed">Elapsed <i class="bi bi-arrow-down-up"></i></th>
                                <th>CPUs</th>
                                <th>Memory</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            {% for job in job_history %}
                            <tr>
                                <td><code>{{ job.id }}</code></td>
                                <td>{{ job.name }}</td>
                                <td>
                                    {% if job.state == 'COMPLETED' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif job.state in ['FAILED', 'CANCELLED', 'TIMEOUT'] %}
                                        <span class="badge bg-danger">{{ job.state }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ job.state }}</span>
                                    {% endif %}
                                </td>
                                <td><code>{{ job.partition }}</code></td>
                                <td data-sort-value="{{ job.start_timestamp|default(0) }}">
                                    {% if job.start and job.start != 'N/A' %}
                                        <small>{{ job.start|truncate(10, end='') }}</small>
                                    {% else %}
                                        <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td data-sort-value="{{ job.elapsed_seconds|default(0) }}" data-sort-type="elapsed"><small>{{ job.elapsed }}</small></td>
                                <td><small>{{ job.alloc_cpus }}/{{ job.req_cpus }}</small></td>
                                <td><small>{{ job.max_rss }}</small></td>
                                <td>
                                    {% set job_id_safe = job.id|replace('.', '_')|replace('-', '_') %}
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="showJobDetails('{{ job.id }}', '{{ job_id_safe }}')"
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#details-{{ job_id_safe }}"
                                            aria-expanded="false">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr class="collapse" id="details-{{ job_id_safe }}">
                                <td colspan="9" class="p-0">
                                    <div class="card card-body m-2 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong>Job Efficiency Report (seff)</strong>
                                            <button class="btn btn-sm btn-close" onclick="hideJobDetails('{{ job.id }}', '{{ job_id_safe }}')"></button>
                                        </div>
                                        <div id="seff-content-{{ job_id_safe }}" class="font-monospace small">
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2">Loading efficiency report...</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            Showing {{ ((current_page - 1) * per_page) + 1 }} to {{ [current_page * per_page, total_history]|min }} of {{ total_history }} jobs
                        </small>
                    </div>
                    <nav aria-label="Job history pagination">
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            {% if total_pages > 1 %}
                                {# Previous #}
                                <li class="page-item{% if current_page == 1 %} disabled{% endif %}">
                                    {% if current_page > 1 %}
                                        <a class="page-link" href="{{ url_for('jobs.jobs', page=current_page - 1) }}">Previous</a>
                                    {% else %}
                                        <span class="page-link">Previous</span>
                                    {% endif %}
                                </li>
                                
                                {# Page numbers - show 5 pages around current #}
                                {% set start = [1, current_page - 2]|max %}
                                {% set end = [total_pages, current_page + 2]|min %}
                                
                                {% if start > 1 %}
                                    <li class="page-item"><a class="page-link" href="{{ url_for('jobs.jobs', page=1) }}">1</a></li>
                                    {% if start > 2 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                                {% endif %}
                                
                                {% for p in range(start, end + 1) %}
                                    <li class="page-item{% if p == current_page %} active{% endif %}">
                                        {% if p == current_page %}
                                            <span class="page-link">{{ p }}</span>
                                        {% else %}
                                            <a class="page-link" href="{{ url_for('jobs.jobs', page=p) }}">{{ p }}</a>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                                
                                {% if end < total_pages %}
                                    {% if end < total_pages - 1 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                                    <li class="page-item"><a class="page-link" href="{{ url_for('jobs.jobs', page=total_pages) }}">{{ total_pages }}</a></li>
                                {% endif %}
                                
                                {# Next #}
                                <li class="page-item{% if current_page == total_pages %} disabled{% endif %}">
                                    {% if current_page < total_pages %}
                                        <a class="page-link" href="{{ url_for('jobs.jobs', page=current_page + 1) }}">Next</a>
                                    {% else %}
                                        <span class="page-link">Next</span>
                                    {% endif %}
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% else %}
                <div class="alert alert-info m-3 mb-0">
                    <small>No job history found.</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if error %}
<div class="alert alert-warning" role="alert">
    <strong>Warning:</strong> {{ error }}
</div>
{% elif partitions %}
    {# Summary Statistics #}
    {% if summary %}
    <div class="row mb-3">
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Partitions</h6>
                    <h4 class="mb-0">{{ summary.total_partitions }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Total Nodes</h6>
                    <h4 class="mb-0">{{ summary.total_nodes }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Available</h6>
                    <h4 class="mb-0 text-success">{{ summary.available_nodes }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Allocated</h6>
                    <h4 class="mb-0 text-primary">{{ summary.allocated_nodes }}</h4>
                </div>
            </div>
        </div>
        {% if summary.total_cores %}
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Total Cores</h6>
                    <h4 class="mb-0">{{ summary.total_cores }}</h4>
                </div>
            </div>
        </div>
        {% endif %}
        {% if summary.running_jobs is not none %}
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Jobs</h6>
                    <h4 class="mb-0">{{ summary.running_jobs }}/{{ summary.pending_jobs }}</h4>
                    <small class="text-muted">R/P</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# Current Partition Status Table (sortable) #}
    <div class="card shadow-sm mb-3">
        <div class="card-header" style="background-color: var(--theme-bg-color);">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Current Partition Status</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0" id="partitionsTable">
                    <thead style="background-color: var(--theme-bg-color);">
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0)">
                                Partition <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(1)">
                                Type <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(2)">
                                Status <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(3)">
                                Time Limit <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(4)">
                                Nodes <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(5)">
                                Availability <i class="fas fa-sort ms-1"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for part in partitions %}
                        <tr>
                            <td>
                                <strong>{{ part.name }}</strong>
                                {% if part.name[-1] == '*' %}
                                    <span class="badge bg-secondary ms-1" title="Default partition">Default</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if part.category == "CPU" %}
                                    <span class="badge bg-primary">CPU</span>
                                {% elif part.category == "GPU" %}
                                    <span class="badge bg-warning text-dark">GPU</span>
                                {% elif part.category == "Large mem" %}
                                    <span class="badge bg-danger">Large mem</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ part.category }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if part.avail == 'up' %}
                                    <span class="badge bg-success">Up</span>
                                {% else %}
                                    <span class="badge bg-danger">Down</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if '-' in part.timelimit %}
                                    {% set time_parts = part.timelimit.split('-') %}
                                    {% set days = time_parts[0]|int %}
                                    {% set hours_part = time_parts[1].split(':')[0]|int %}
                                    {% if days > 0 %}
                                        {{ days }}d{% if hours_part > 0 %}{{ hours_part }}h{% endif %}
                                    {% else %}
                                        {{ hours_part }}h
                                    {% endif %}
                                {% else %}
                                    {{ part.timelimit.split(':')[0] }}h
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-success"><strong>{{ part.idle }}</strong></span> / <strong>{{ part.total }}</strong>
                                <small class="text-muted d-block">({{ part.allocated }} allocated)</small>
                            </td>
                            <td>
                                {% if part.availability_pct >= 75 %}
                                    <span class="badge bg-success">{{ part.availability_pct }}%</span>
                                {% elif part.availability_pct >= 50 %}
                                    <span class="badge bg-info">{{ part.availability_pct }}%</span>
                                {% elif part.availability_pct >= 25 %}
                                    <span class="badge bg-warning text-dark">{{ part.availability_pct }}%</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ part.availability_pct }}%</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# Partition Reference Table #}
    {% if partition_reference %}
    <div class="card shadow-sm mb-3">
        <div class="card-header" style="background-color: var(--theme-bg-color);">
            <h5 class="mb-0"><i class="fas fa-book me-2"></i>Partition Reference Information</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead style="background-color: var(--theme-bg-color);">
                        <tr>
                            <th>Partition</th>
                            <th>Nodes</th>
                            <th>Nodes Per Researcher</th>
                            <th>Priority Tier</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in ["CPU", "GPU", "Large mem"] %}
                            {% if partition_reference.get(category) %}
                            <tr class="table-secondary">
                                <td colspan="4"><strong>{{ category }}</strong></td>
                            </tr>
                            {% for ref in partition_reference[category] %}
                            <tr>
                                <td><strong>{{ ref.name }}</strong></td>
                                <td>{{ ref.nodes }}</td>
                                <td>
                                    {% if ref.nodes_per_researcher == "UNLIMITED" %}
                                        <span class="badge bg-success">UNLIMITED</span>
                                    {% else %}
                                        {{ ref.nodes_per_researcher }}
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-secondary">{{ ref.priority_tier }}</span></td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {# Legend #}
    <div class="card shadow-sm">
        <div class="card-header" style="background-color: var(--theme-bg-color);">
            <h6 class="mb-0">Legend</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="small mb-2"><strong>Node Status:</strong></p>
                    <ul class="small mb-0">
                        <li><strong>A</strong> = Allocated (in use)</li>
                        <li><strong>I</strong> = Idle (available)</li>
                        <li><strong>O</strong> = Other (down, draining, etc.)</li>
                        <li><strong>T</strong> = Total nodes</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <p class="small mb-2"><strong>Availability Colors:</strong></p>
                    <ul class="small mb-0">
                        <li><span class="badge bg-success">75%+</span> Excellent availability</li>
                        <li><span class="badge bg-info">50-74%</span> Good availability</li>
                        <li><span class="badge bg-warning text-dark">25-49%</span> Limited availability</li>
                        <li><span class="badge bg-danger">&lt;25%</span> Low availability</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="alert alert-secondary">
        <p class="mb-0">No partition information available.</p>
    </div>
{% endif %}

<script>
// Table sorting functionality
let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.getElementById('partitionsTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    if (!sortDirection[columnIndex]) {
        sortDirection[columnIndex] = 'asc';
    } else if (sortDirection[columnIndex] === 'asc') {
        sortDirection[columnIndex] = 'desc';
    } else {
        sortDirection[columnIndex] = 'asc';
    }
    
    const direction = sortDirection[columnIndex];
    
    // Sort rows
    rows.sort((a, b) => {
        const aCell = a.cells[columnIndex];
        const bCell = b.cells[columnIndex];
        
        let aValue = aCell.textContent.trim();
        let bValue = bCell.textContent.trim();
        
        // Handle numeric values (availability percentage, nodes)
        if (columnIndex === 5) { // Availability column
            const aMatch = aValue.match(/(\d+\.?\d*)/);
            const bMatch = bValue.match(/(\d+\.?\d*)/);
            aValue = aMatch ? parseFloat(aMatch[1]) : 0;
            bValue = bMatch ? parseFloat(bMatch[1]) : 0;
        } else if (columnIndex === 4) { // Nodes column - extract total (format: "X / Y")
            const aMatch = aValue.match(/\/(\d+)/);
            const bMatch = bValue.match(/\/(\d+)/);
            aValue = aMatch ? parseInt(aMatch[1]) : 0;
            bValue = bMatch ? parseInt(bMatch[1]) : 0;
        } else {
            // String comparison
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Remove all rows
    rows.forEach(row => tbody.removeChild(row));
    
    // Add sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons
    const headers = table.querySelectorAll('thead th');
    headers.forEach((header, idx) => {
        const icon = header.querySelector('i');
        if (icon) {
            if (idx === columnIndex) {
                icon.className = direction === 'asc' ? 'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1';
            } else {
                icon.className = 'fas fa-sort ms-1';
            }
        }
    });
    
    // Job history pagination (kept for potential future AJAX use)
    // Note: Currently using server-side pagination, but keeping this for reference
    const urlParams = new URLSearchParams(window.location.search);
    let currentPage = parseInt(urlParams.get('page')) || 1;
    const perPage = 10;
    
    function loadJobHistory(page) {
        fetch(`{{ url_for('jobs.jobs_history') }}?page=${page}&per_page=${perPage}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading job history:', data.error);
                    return;
                }
                
                currentPage = data.page;
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) return;
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                // Add new rows
                data.jobs.forEach(job => {
                    const row = document.createElement('tr');
                    
                    // State badge
                    let stateBadge = '';
                    if (job.state === 'COMPLETED') {
                        stateBadge = '<span class="badge bg-success">Completed</span>';
                    } else if (['FAILED', 'CANCELLED', 'TIMEOUT'].includes(job.state)) {
                        stateBadge = `<span class="badge bg-danger">${job.state}</span>`;
                    } else {
                        stateBadge = `<span class="badge bg-secondary">${job.state}</span>`;
                    }
                    
                    const safeJobId = job.id.replace(/[.-]/g, '_');
                    row.innerHTML = `
                        <td><code>${job.id}</code></td>
                        <td>${job.name}</td>
                        <td>${stateBadge}</td>
                        <td><code>${job.partition}</code></td>
                        <td data-sort-value="${job.start_timestamp || 0}"><small>${job.start || 'N/A'}</small></td>
                        <td data-sort-value="${job.elapsed_seconds || 0}" data-sort-type="elapsed"><small>${job.elapsed}</small></td>
                        <td><small>${job.alloc_cpus}/${job.req_cpus}</small></td>
                        <td><small>${job.max_rss}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="showJobDetails('${job.id}', '${safeJobId}')"
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#details-${safeJobId}"
                                    aria-expanded="false">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination
                updatePagination(data.total_pages, data.page);
            })
            .catch(error => {
                console.error('Error loading job history:', error);
            });
    }
    
    function updatePagination(totalPages, currentPageNum) {
        const pagination = document.getElementById('historyPagination');
        if (!pagination) return;
        
        pagination.innerHTML = '';
        
        if (totalPages <= 1) {
            return;
        }
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPageNum === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadJobHistory(${currentPageNum - 1}); return false;">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        const startPage = Math.max(1, currentPageNum - 2);
        const endPage = Math.min(totalPages, currentPageNum + 2);
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" onclick="loadJobHistory(1); return false;">1</a>`;
            pagination.appendChild(firstLi);
            if (startPage > 2) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'page-item disabled';
                ellipsis.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(ellipsis);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPageNum ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="loadJobHistory(${i}); return false;">${i}</a>`;
            pagination.appendChild(li);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'page-item disabled';
                ellipsis.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(ellipsis);
            }
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" onclick="loadJobHistory(${totalPages}); return false;">${totalPages}</a>`;
            pagination.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPageNum === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadJobHistory(${currentPageNum + 1}); return false;">Next</a>`;
        pagination.appendChild(nextLi);
    }
    
    // Refresh history button
    const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
    if (refreshHistoryBtn) {
        refreshHistoryBtn.addEventListener('click', function() {
            // Reload the page to refresh job history
            const urlParams = new URLSearchParams(window.location.search);
            const currentPage = urlParams.get('page') || 1;
            window.location.href = `{{ url_for('jobs.jobs') }}?page=${currentPage}`;
        });
    }
    
    // Job details (seff) functionality
    function showJobDetails(jobId, safeJobId) {
        const contentDiv = document.getElementById('seff-content-' + safeJobId);
        
        if (!contentDiv) {
            console.error('Content div not found for job:', jobId);
            return;
        }
        
        // Check if we've already loaded the content
        if (contentDiv.dataset.loaded === 'true') {
            return;
        }
        
        // Fetch seff output
        const baseUrl = '{{ url_for("jobs.job_efficiency", job_id="JOB_ID") }}';
        const url = baseUrl.replace('JOB_ID', encodeURIComponent(jobId));
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    contentDiv.innerHTML = '<div class="alert alert-warning mb-0">' + escapeHtml(data.error) + '</div>';
                } else {
                    // Display the raw seff output in a pre-formatted block
                    const output = data.raw_output || '';
                    contentDiv.innerHTML = '<pre class="mb-0" style="white-space: pre-wrap; font-size: 0.85em;">' + escapeHtml(output) + '</pre>';
                    contentDiv.dataset.loaded = 'true';
                }
            })
            .catch(error => {
                console.error('Error loading job efficiency:', error);
                contentDiv.innerHTML = '<div class="alert alert-danger mb-0">Error loading efficiency report: ' + escapeHtml(error.message) + '</div>';
            });
    }
    
    function hideJobDetails(jobId, safeJobId) {
        const collapseElement = document.getElementById('details-' + safeJobId);
        if (collapseElement) {
            const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
            bsCollapse.hide();
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Make functions available globally
    window.showJobDetails = showJobDetails;
    window.hideJobDetails = hideJobDetails;
    
    // Table sorting functionality
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('historyTable');
        if (!table) return;
        
        const headers = table.querySelectorAll('th.sortable');
        let sortColumn = null;
        let sortDirection = 'desc'; // Default: most recent first
        
        headers.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const column = this.dataset.sort;
                if (sortColumn === column) {
                    // Toggle direction
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                
                // Update header indicators
                headers.forEach(h => {
                    h.innerHTML = h.innerHTML.replace(/<i[^>]*><\/i>/g, '');
                    if (h === this) {
                        const icon = sortDirection === 'asc' ? '↑' : '↓';
                        h.innerHTML += ` <i>${icon}</i>`;
                    }
                });
                
                // Sort table
                sortTable(column, sortDirection);
            });
        });
        
        function sortTable(column, direction) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'start') {
                    // Find the start date column (4th column, index 4)
                    const aTds = a.querySelectorAll('td');
                    const bTds = b.querySelectorAll('td');
                    if (aTds.length > 4 && aTds[4].hasAttribute('data-sort-value')) {
                        aVal = parseFloat(aTds[4].dataset.sortValue || 0);
                    } else {
                        aVal = 0;
                    }
                    if (bTds.length > 4 && bTds[4].hasAttribute('data-sort-value')) {
                        bVal = parseFloat(bTds[4].dataset.sortValue || 0);
                    } else {
                        bVal = 0;
                    }
                } else if (column === 'elapsed') {
                    // Find the elapsed column by data-sort-type attribute
                    const aElapsed = a.querySelector('td[data-sort-type="elapsed"]');
                    const bElapsed = b.querySelector('td[data-sort-type="elapsed"]');
                    aVal = parseFloat(aElapsed?.dataset.sortValue || 0);
                    bVal = parseFloat(bElapsed?.dataset.sortValue || 0);
                } else {
                    return 0;
                }
                
                if (direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }
    });
</script>
{% endblock %}
