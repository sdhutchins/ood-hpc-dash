{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <br/>
        <h3 class="pb-2 mb-3 border-bottom">Cluster Partitions & Job Status</h3>
        <p class="text-muted mb-3">
            Monitor cluster resources and partition availability. Use this information to choose the best partition for your job submission.
        </p>
        <div class="mb-3">
            <a href="https://docs.rc.uab.edu/cheaha/hardware/" target="_blank" class="btn btn-sm me-2" style="background-color: var(--theme-bg-color); border-color: var(--theme-bg-color); color: var(--theme-text-color);">
                <i class="fas fa-external-link-alt me-1"></i>Hardware Documentation
            </a>
            <a href="https://docs.rc.uab.edu/cheaha/job_efficiency/" target="_blank" class="btn btn-sm" style="background-color: var(--theme-bg-color); border-color: var(--theme-bg-color); color: var(--theme-text-color);">
                <i class="fas fa-external-link-alt me-1"></i>Job Efficiency Guide
            </a>
        </div>
    </div>
</div>

{% if error %}
<div class="alert alert-warning" role="alert">
    <strong>Warning:</strong> {{ error }}
</div>
{% elif partitions %}
    {# Summary Statistics #}
    {% if summary %}
    <div class="row mb-3">
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Partitions</h6>
                    <h4 class="mb-0">{{ summary.total_partitions }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Total Nodes</h6>
                    <h4 class="mb-0">{{ summary.total_nodes }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Available</h6>
                    <h4 class="mb-0 text-success">{{ summary.available_nodes }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Allocated</h6>
                    <h4 class="mb-0 text-primary">{{ summary.allocated_nodes }}</h4>
                </div>
            </div>
        </div>
        {% if summary.total_cores %}
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Total Cores</h6>
                    <h4 class="mb-0">{{ summary.total_cores }}</h4>
                </div>
            </div>
        </div>
        {% endif %}
        {% if summary.running_jobs is not none %}
        <div class="col-md-2 col-6 mb-2">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-2">
                    <h6 class="card-title text-muted mb-0 small">Jobs</h6>
                    <h4 class="mb-0">{{ summary.running_jobs }}/{{ summary.pending_jobs }}</h4>
                    <small class="text-muted">R/P</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# Current Partition Status Table (sortable) #}
    <div class="card shadow-sm mb-3">
        <div class="card-header" style="background-color: var(--theme-bg-color);">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Current Partition Status</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0" id="partitionsTable">
                    <thead style="background-color: var(--theme-bg-color);">
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0)">
                                Partition <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(1)">
                                Type <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(2)">
                                Status <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(3)">
                                Time Limit <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(4)">
                                Nodes <i class="fas fa-sort ms-1"></i>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable(5)">
                                Availability <i class="fas fa-sort ms-1"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for part in partitions %}
                        <tr>
                            <td>
                                <strong>{{ part.name }}</strong>
                                {% if part.name[-1] == '*' %}
                                    <span class="badge bg-secondary ms-1" title="Default partition">Default</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if part.category == "CPU" %}
                                    <span class="badge bg-primary">CPU</span>
                                {% elif part.category == "GPU" %}
                                    <span class="badge bg-warning text-dark">GPU</span>
                                {% elif part.category == "Large mem" %}
                                    <span class="badge bg-danger">Large mem</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ part.category }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if part.avail == 'up' %}
                                    <span class="badge bg-success">Up</span>
                                {% else %}
                                    <span class="badge bg-danger">Down</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if '-' in part.timelimit %}
                                    {% set time_parts = part.timelimit.split('-') %}
                                    {% set days = time_parts[0]|int %}
                                    {% set hours_part = time_parts[1].split(':')[0]|int %}
                                    {% if days > 0 %}
                                        {{ days }}d{% if hours_part > 0 %}{{ hours_part }}h{% endif %}
                                    {% else %}
                                        {{ hours_part }}h
                                    {% endif %}
                                {% else %}
                                    {{ part.timelimit.split(':')[0] }}h
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-success"><strong>{{ part.idle }}</strong></span> / <strong>{{ part.total }}</strong>
                                <small class="text-muted d-block">({{ part.allocated }} allocated)</small>
                            </td>
                            <td>
                                {% if part.availability_pct >= 75 %}
                                    <span class="badge bg-success">{{ part.availability_pct }}%</span>
                                {% elif part.availability_pct >= 50 %}
                                    <span class="badge bg-info">{{ part.availability_pct }}%</span>
                                {% elif part.availability_pct >= 25 %}
                                    <span class="badge bg-warning text-dark">{{ part.availability_pct }}%</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ part.availability_pct }}%</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# Partition Reference Table #}
    {% if partition_reference %}
    <div class="card shadow-sm mb-3">
        <div class="card-header" style="background-color: var(--theme-bg-color);">
            <h5 class="mb-0"><i class="fas fa-book me-2"></i>Partition Reference Information</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead style="background-color: var(--theme-bg-color);">
                        <tr>
                            <th>Partition</th>
                            <th>Nodes</th>
                            <th>Nodes Per Researcher</th>
                            <th>Priority Tier</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in ["CPU", "GPU", "Large mem"] %}
                            {% if partition_reference.get(category) %}
                            <tr class="table-secondary">
                                <td colspan="4"><strong>{{ category }}</strong></td>
                            </tr>
                            {% for ref in partition_reference[category] %}
                            <tr>
                                <td><strong>{{ ref.name }}</strong></td>
                                <td>{{ ref.nodes }}</td>
                                <td>
                                    {% if ref.nodes_per_researcher == "UNLIMITED" %}
                                        <span class="badge bg-success">UNLIMITED</span>
                                    {% else %}
                                        {{ ref.nodes_per_researcher }}
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-secondary">{{ ref.priority_tier }}</span></td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {# Legend #}
    <div class="card shadow-sm">
        <div class="card-header" style="background-color: var(--theme-bg-color);">
            <h6 class="mb-0">Legend</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="small mb-2"><strong>Node Status:</strong></p>
                    <ul class="small mb-0">
                        <li><strong>A</strong> = Allocated (in use)</li>
                        <li><strong>I</strong> = Idle (available)</li>
                        <li><strong>O</strong> = Other (down, draining, etc.)</li>
                        <li><strong>T</strong> = Total nodes</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <p class="small mb-2"><strong>Availability Colors:</strong></p>
                    <ul class="small mb-0">
                        <li><span class="badge bg-success">75%+</span> Excellent availability</li>
                        <li><span class="badge bg-info">50-74%</span> Good availability</li>
                        <li><span class="badge bg-warning text-dark">25-49%</span> Limited availability</li>
                        <li><span class="badge bg-danger">&lt;25%</span> Low availability</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="alert alert-secondary">
        <p class="mb-0">No partition information available.</p>
    </div>
{% endif %}

<script>
// Table sorting functionality
let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.getElementById('partitionsTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    if (!sortDirection[columnIndex]) {
        sortDirection[columnIndex] = 'asc';
    } else if (sortDirection[columnIndex] === 'asc') {
        sortDirection[columnIndex] = 'desc';
    } else {
        sortDirection[columnIndex] = 'asc';
    }
    
    const direction = sortDirection[columnIndex];
    
    // Sort rows
    rows.sort((a, b) => {
        const aCell = a.cells[columnIndex];
        const bCell = b.cells[columnIndex];
        
        let aValue = aCell.textContent.trim();
        let bValue = bCell.textContent.trim();
        
        // Handle numeric values (availability percentage, nodes)
        if (columnIndex === 5) { // Availability column
            const aMatch = aValue.match(/(\d+\.?\d*)/);
            const bMatch = bValue.match(/(\d+\.?\d*)/);
            aValue = aMatch ? parseFloat(aMatch[1]) : 0;
            bValue = bMatch ? parseFloat(bMatch[1]) : 0;
        } else if (columnIndex === 4) { // Nodes column - extract total (format: "X / Y")
            const aMatch = aValue.match(/\/(\d+)/);
            const bMatch = bValue.match(/\/(\d+)/);
            aValue = aMatch ? parseInt(aMatch[1]) : 0;
            bValue = bMatch ? parseInt(bMatch[1]) : 0;
        } else {
            // String comparison
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Remove all rows
    rows.forEach(row => tbody.removeChild(row));
    
    // Add sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons
    const headers = table.querySelectorAll('thead th');
    headers.forEach((header, idx) => {
        const icon = header.querySelector('i');
        if (icon) {
            if (idx === columnIndex) {
                icon.className = direction === 'asc' ? 'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1';
            } else {
                icon.className = 'fas fa-sort ms-1';
            }
        }
    });
}
</script>
{% endblock %}
