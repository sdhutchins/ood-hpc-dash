{% extends "base.html" %}

{% block content %}
<style>
#projectsList {
    min-height: 200px;
}
.project-card .card {
    overflow: hidden;
}
.project-card .btn[aria-expanded="true"] .fa-chevron-down {
    transform: rotate(180deg);
}
.project-card .btn .fa-chevron-down {
    transition: transform 0.2s ease;
}
.pagination {
    margin-top: 1rem;
}
</style>

<div class="row mb-4">
    <div class="col">
        <br/>
        <h3 class="pb-2 mb-3 border-bottom">Project Monitor</h3>
        <p class="text-muted mb-3">
            Monitor git repository freshness, reproducibility health, and filesystem drift across your projects.
        </p>
        <div class="mb-3">
            <button type="button" class="btn btn-sm" id="refreshProjectsBtn" style="background-color: var(--theme-bg-color); border-color: var(--theme-bg-color); color: var(--theme-text-color);">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <span class="ms-3 text-muted">
                <small>Scanning: {{ project_dirs|join(', ') }}</small>
            </span>
        </div>
    </div>
</div>

<div id="projectsPageData" 
     data-loading="{{ 'true' if loading else 'false' }}"
     data-status-url="{{ url_for('projects.projects_status') }}"
     style="display: none;"></div>

<div id="loadingIndicator" class="row mb-4" style="display: none;">
    <div class="col">
        <div class="card shadow-sm">
            <div class="card-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h5>Scanning for git repositories...</h5>
                <p class="text-muted mb-0">This may take a moment for large directories.</p>
            </div>
        </div>
    </div>
</div>

<div id="errorMessage" class="row mb-4" style="display: none;">
    <div class="col">
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
    </div>
</div>

<div id="projectsContainer">
    <div class="row mb-4" id="noProjectsMessage" style="display: none;">
        <div class="col">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No git repositories found in configured directories.
                <br/>
                <small>Configure project directories in Settings.</small>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    const el = (id) => document.getElementById(id);
    const show = (el) => el && (el.style.display = 'block');
    const hide = (el) => el && (el.style.display = 'none');
    
    let allProjects = [];
    let currentPage = 1;
    const perPage = 20;
    let fetchController = null;
    
    function loadProjectsData() {
        const loading = el('loadingIndicator');
        const error = el('errorMessage');
        const errorText = el('errorText');
        const noProjects = el('noProjectsMessage');
        
        // Abort any existing fetch
        if (fetchController) {
            fetchController.abort();
        }
        
        show(loading);
        hide(error);
        hide(noProjects);
        
        const url = el('projectsPageData')?.dataset.statusUrl || '/projects/status';
        fetchController = new AbortController();
        const timeoutId = setTimeout(() => {
            fetchController.abort();
        }, 60000); // 60 second timeout
        
        fetch(url, { signal: fetchController.signal })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                return response.json();
            })
            .then(data => {
                hide(loading);
                fetchController = null;
                if (data.error) {
                    if (errorText) errorText.textContent = data.error;
                    show(error);
                    return;
                }
                if (!data.projects || data.projects.length === 0) {
                    show(noProjects);
                    return;
                }
                allProjects = data.projects;
                currentPage = 1;
                renderProjects();
            })
            .catch(err => {
                clearTimeout(timeoutId);
                hide(loading);
                fetchController = null;
                if (err.name === 'AbortError') {
                    // Abort is expected when user clicks refresh or timeout occurs
                    // Don't show error or log - the new request will handle it
                    return;
                }
                if (errorText) errorText.textContent = 'Error loading projects: ' + err.message;
                show(error);
                console.error('Error loading projects:', err);
            });
    }
    
    function renderProjects() {
        const container = el('projectsContainer');
        if (!container) return;
        
        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const pageProjects = allProjects.slice(start, end);
        const totalPages = Math.ceil(allProjects.length / perPage);
        
        let html = `
            <div class="row mb-3">
                <div class="col">
                    <div class="alert alert-info py-2">
                        <strong>${allProjects.length}</strong> git repositories found.
                    </div>
                </div>
            </div>
            <div id="projectsAccordion">
                <div id="projectsList">`;
        
        pageProjects.forEach((project, idx) => {
            const index = start + idx;
            const git = project.git || {};
            const repro = project.reproducibility || {};
            const drift = project.drift_footprint || {};
            
            // Use project path for stable, unique IDs (path is unique per project)
            // Hash the path to create a short, stable identifier that doesn't change with pagination
            const pathStr = String(project.path || project.name || 'project');
            let pathHash = 0;
            for (let i = 0; i < pathStr.length; i++) {
                const char = pathStr.charCodeAt(i);
                pathHash = ((pathHash << 5) - pathHash) + char;
                pathHash = pathHash | 0; // Convert to 32-bit integer
            }
            const safeId = Math.abs(pathHash).toString(36).substring(0, 8);
            const detailsId = `details-${safeId}-${index}`;
            
            const stateBadge = git.dirty 
                ? '<span class="badge bg-warning text-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="Repository has uncommitted changes">Dirty</span>' 
                : git.ahead || git.behind 
                    ? `<span class="badge bg-info" data-bs-toggle="tooltip" data-bs-placement="top" title="Repository has commits ahead of remote">Ahead</span>${git.behind ? '<span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Repository is behind remote (needs pull)">Behind</span>' : ''}` 
                    : '<span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Repository is clean (no uncommitted changes)">Clean</span>';
            
            const envCount = Array.isArray(repro.environment_files) ? repro.environment_files.length : 0;
            const workflowCount = Array.isArray(repro.workflow_configs) ? repro.workflow_configs.length : 0;
            // Fix: Use sum, not OR
            const reproInfo = (envCount + workflowCount > 0) 
                ? `<span data-bs-toggle="tooltip" data-bs-placement="top" title="Environment files: ${envCount}, Workflow configs: ${workflowCount}"><i class="fas fa-file-code"></i> ${envCount} <i class="fas fa-cogs ms-1"></i> ${workflowCount}</span>` 
                : '';
            
            const driftBadge = drift.drift_days > 0 
                ? `<span class="badge bg-warning text-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="Files modified ${drift.drift_days} day${drift.drift_days !== 1 ? 's' : ''} after last commit"><i class="fas fa-clock"></i> ${drift.drift_days}d</span>` 
                : '';
            
            const sizeInfo = drift.directory_size 
                ? `<span class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Total directory size"><i class="fas fa-hdd"></i> ${(drift.directory_size / (1024*1024)).toFixed(1)} MB</span>` 
                : '';
            
            const commitDate = git.last_commit_date ? git.last_commit_date.substring(0, 10) : '';
            
            // Defensive array checks
            const envList = Array.isArray(repro.environment_files) 
                ? repro.environment_files.map(f => `<li>Env: ${escapeHtml(f?.name || 'unknown')}</li>`).join('') 
                : '';
            const workflowList = Array.isArray(repro.workflow_configs) 
                ? repro.workflow_configs.map(w => `<li>Workflows: ${escapeHtml(w?.name || 'unknown')}</li>`).join('') 
                : '';
            const missingList = Array.isArray(repro.missing_common_files) && repro.missing_common_files.length > 0
                ? `<li class="text-warning">Missing: ${escapeHtml(repro.missing_common_files.join(', '))}</li>` 
                : '';
            const untrackedList = Array.isArray(drift.large_untracked_files) && drift.large_untracked_files.length > 0
                ? `<li>Large untracked: ${drift.large_untracked_files.length} file(s)</li>` 
                : '';
            
            // Fix: Safe remote URL handling with null check
            const remoteHtml = git.remote && typeof git.remote === 'string'
                ? `<a href="${escapeHtml(git.remote)}" target="_blank">${escapeHtml(git.remote.length > 40 ? git.remote.substring(0, 40) + '...' : git.remote)}</a>`
                : '<span class="text-muted">None</span>';
            
            html += `
<div class="row mb-2 project-card">
    <div class="col">
        <div class="card shadow-sm">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1" style="min-width: 0;">
                        <h6 class="mb-1 text-truncate">
                            <i class="fas fa-folder me-1"></i>${escapeHtml(project.name)}
                            <small class="text-muted ms-2">${escapeHtml(project.path)}</small>
                        </h6>
                        <div class="d-flex flex-wrap gap-2 align-items-center small">
                            ${stateBadge}
                            <span><code class="small">${escapeHtml(git.branch || 'N/A')}</code></span>
                            ${commitDate ? `<span class="text-muted">${commitDate}</span>` : ''}
                            ${reproInfo}
                            ${driftBadge}
                            ${sizeInfo}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary ms-2 flex-shrink-0" 
                            type="button"
                            data-bs-toggle="collapse" 
                            data-bs-target="#${detailsId}"
                            aria-expanded="false"
                            aria-controls="${detailsId}">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse mt-2 pt-2 border-top" id="${detailsId}" data-bs-parent="#projectsAccordion">
                    <div class="row small">
                        <div class="col-md-4">
                            <strong>Git:</strong>
                            <ul class="list-unstyled mb-0 mt-1">
                                <li>Remote: ${remoteHtml}</li>
                                <li>Commit: <code>${escapeHtml(git.last_commit || 'N/A')}</code></li>
                                <li>Author: ${escapeHtml(git.last_commit_author || 'N/A')}</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <strong>Reproducibility:</strong>
                            <ul class="list-unstyled mb-0 mt-1">
                                ${envList}${workflowList}${missingList}${untrackedList}
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <strong>Footprint:</strong>
                            <ul class="list-unstyled mb-0 mt-1">
                                ${drift.git_size ? `<li>Git: ${(drift.git_size / (1024*1024)).toFixed(1)} MB</li>` : ''}
                                ${drift.last_modified ? `<li>Modified: ${drift.last_modified.substring(0, 10)}</li>` : ''}
                                ${drift.last_commit ? `<li>Commit: ${drift.last_commit.substring(0, 10)}</li>` : ''}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>`;
        });
        
        html += `</div></div>`; // Close projectsList and projectsAccordion
        
        if (totalPages > 1) {
            html += `<div id="projectsPagination"></div>`;
        }
        
        container.innerHTML = html;
        
        if (totalPages > 1) {
            renderPagination(totalPages);
        }
        
        // Initialize Bootstrap collapse for dynamically added elements
        // Use getOrCreateInstance to avoid dispose/recreate issues
        // Note: This runs on every pagination render, but since innerHTML recreates DOM nodes,
        // each element gets exactly one instance. This is harmless and ensures proper initialization.
        requestAnimationFrame(() => {
            const collapseElements = container.querySelectorAll('.collapse');
            collapseElements.forEach(collapseEl => {
                // Use getOrCreateInstance - no dispose/recreate needed
                bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
            });
            
            // Initialize Bootstrap tooltips for badges and info elements
            const tooltipElements = container.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipElements.forEach(tooltipEl => {
                // Dispose existing tooltip if it exists
                const existingTooltip = bootstrap.Tooltip.getInstance(tooltipEl);
                if (existingTooltip) {
                    existingTooltip.dispose();
                }
                // Create new tooltip with fast hover
                new bootstrap.Tooltip(tooltipEl, {
                    trigger: 'hover',
                    delay: { show: 100, hide: 0 },
                    container: 'body'
                });
            });
        });
    }
    
    function renderPagination(totalPages) {
        const container = el('projectsPagination');
        if (!container || totalPages <= 1) {
            if (container) container.innerHTML = '';
            return;
        }
        
        let html = '<nav aria-label="Projects pagination"><ul class="pagination pagination-sm justify-content-center mb-0">';
        
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">`;
        html += currentPage === 1 
            ? '<span class="page-link">Previous</span>'
            : `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        html += '</li>';
        
        const showPages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(showPages / 2));
        let endPage = Math.min(totalPages, startPage + showPages - 1);
        
        if (endPage - startPage < showPages - 1) {
            startPage = Math.max(1, endPage - showPages + 1);
        }
        
        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
            if (startPage > 2) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">`;
            html += i === currentPage
                ? `<span class="page-link">${i}</span>`
                : `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            html += '</li>';
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
        }
        
        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">`;
        html += currentPage === totalPages
            ? '<span class="page-link">Next</span>'
            : `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        html += '</li>';
        
        html += '</ul></nav>';
        container.innerHTML = html;
        
        // Use event delegation for pagination
        container.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page && page !== currentPage) {
                    currentPage = page;
                    renderProjects();
                }
            });
        });
    }
    
    function escapeHtml(text) {
        // Handle non-string input safely
        if (typeof text !== 'string') {
            text = String(text ?? '');
        }
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        const container = el('projectsContainer');
        
        // Single delegated listener for collapse state changes (set up once)
        // Updates aria-expanded on all collapse elements
        if (container) {
            container.addEventListener('shown.bs.collapse', function(e) {
                const targetId = '#' + e.target.id;
                const button = document.querySelector(`[data-bs-target="${targetId}"]`);
                if (button) {
                    button.setAttribute('aria-expanded', 'true');
                }
            });
            
            container.addEventListener('hidden.bs.collapse', function(e) {
                const targetId = '#' + e.target.id;
                const button = document.querySelector(`[data-bs-target="${targetId}"]`);
                if (button) {
                    button.setAttribute('aria-expanded', 'false');
                }
            });
        }
        
        const pageData = el('projectsPageData');
        if (pageData?.dataset.loading === 'true') {
            loadProjectsData();
        }
        
        el('refreshProjectsBtn')?.addEventListener('click', function() {
            const icon = this.querySelector('i');
            icon.classList.add('fa-spin');
            this.disabled = true;
            loadProjectsData();
            setTimeout(() => {
                icon.classList.remove('fa-spin');
                this.disabled = false;
            }, 1000);
        });
    });
})();
</script>
{% endblock %}
