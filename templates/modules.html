{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <p class="text-muted">Available modules from 'module -t spider'.</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="moduleSearch" class="form-label visually-hidden">Search modules</label>
        <input 
            type="text" 
            id="moduleSearch" 
            placeholder="Search modules..." 
            class="form-control"
            aria-label="Search modules by name or version"
        >
    </div>
    <div class="col-md-4">
        <label for="categoryFilter" class="form-label visually-hidden">Filter by category</label>
        <select id="categoryFilter" class="form-select" aria-label="Filter modules by category">
            <option value="">All Categories</option>
            {% if category_order %}
                {% for category in category_order %}
                    <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>
    <div class="col-md-4 d-flex align-items-center">
        <small class="text-muted">
            <strong id="uniqueCount" aria-live="polite">{{ unique_count or 0 }}</strong> unique software packages
        </small>
    </div>
</div>

<div class="row">
    <div class="col">
        <div id="loadingCard" class="card {% if modules and modules|length > 0 %}d-none{% endif %}">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading modules...</p>
            </div>
        </div>
        <div id="modulesCard" class="{% if not modules or modules|length == 0 %}d-none{% endif %}">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" style="width: 30%;">Name</th>
                                    <th scope="col">Versions Available</th>
                                </tr>
                            </thead>
                            <tbody id="modulesTableBody">
                                {% if modules %}
                                {% for module in modules %}
                                <tr class="module-row" data-category="{{ module.category }}">
                                    <td><code>{{ module.name }}</code></td>
                                    <td>
                                        {% if module.versions %}
                                            {% for version in module.versions %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm copy-version me-1 mb-1" data-version="{{ version }}" title="Click to copy: module load {{ version }}">
                                                    <i class="fa-regular fa-copy me-1"></i><code class="text-reset">{{ version }}</code>
                                                </button>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Debounce function for performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('moduleSearch');
        const categoryFilter = document.getElementById('categoryFilter');
        let allModules = {% if modules %}{{ modules|tojson|safe }}{% else %}[]{% endif %};
        let categoryOrder = {% if category_order %}{{ category_order|tojson|safe }}{% else %}[]{% endif %};
        
        {% if not modules or modules|length == 0 %}
        // Poll for modules if page loaded empty
        function fetchModules() {
            fetch('{{ url_for("modules.modules_list") }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.loading) {
                        setTimeout(fetchModules, 2000);
                    } else if (data.modules && data.modules.length > 0) {
                        allModules = data.modules;
                        categoryOrder = data.category_order || [];
                        document.getElementById('loadingCard').classList.add('d-none');
                        document.getElementById('modulesCard').classList.remove('d-none');
                        const countEl = document.getElementById('uniqueCount');
                        if (countEl) {
                            countEl.textContent = data.unique_count || data.modules.length;
                        }
                        displayModules(data.modules);
                        populateCategoryFilter(categoryOrder);
                    }
                })
                .catch(error => {
                    console.error('Error fetching modules:', error);
                    setTimeout(fetchModules, 2000);
                });
        }
        
        fetchModules();
        {% else %}
        // Populate category filter if modules are already loaded
        populateCategoryFilter(categoryOrder);
        {% endif %}
        
        function populateCategoryFilter(categories) {
            if (!categoryFilter || categories.length === 0) return;
            
            // Clear existing options except "All Categories"
            while (categoryFilter.options.length > 1) {
                categoryFilter.remove(1);
            }
            
            // Add category options
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function displayModules(modules) {
            const tbody = document.getElementById('modulesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Ensure modules are sorted alphabetically by name (case-insensitive)
            const sortedModules = [...modules].sort((a, b) => {
                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            });
            
            sortedModules.forEach(module => {
                const row = document.createElement('tr');
                row.className = 'module-row';
                row.setAttribute('data-category', module.category || 'Misc');
                
                const nameCell = document.createElement('td');
                nameCell.innerHTML = '<code>' + escapeHtml(module.name) + '</code>';
                
                const versionsCell = document.createElement('td');
                if (module.versions && module.versions.length > 0) {
                    versionsCell.innerHTML = module.versions.map(v => 
                        '<button type="button" class="btn btn-outline-secondary btn-sm copy-version me-1 mb-1" data-version="' + escapeHtml(v) + '" title="Click to copy: module load ' + escapeHtml(v) + '"><i class="fa-regular fa-copy me-1"></i><code class="text-reset">' + escapeHtml(v) + '</code></button>'
                    ).join('');
                } else {
                    versionsCell.innerHTML = '<span class="text-muted">-</span>';
                }
                
                row.appendChild(nameCell);
                row.appendChild(versionsCell);
                tbody.appendChild(row);
            });
            
            // Apply current filters
            applyFilters();
            // Wire copy buttons
            attachCopyHandlers();
        }
        
        function applyFilters() {
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const selectedCategory = categoryFilter ? categoryFilter.value : '';
            const rows = document.querySelectorAll('.module-row');
            
            if (rows.length === 0) return;
            
            // Create regex based on search term length and content
            let nameRegex = null;
            let versionRegex = null;
            if (searchTerm) {
                const escaped = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const hasNumbers = /\d/.test(searchTerm);
                
                // Versions: search if contains numbers (any length) OR if 3+ characters
                if (hasNumbers || searchTerm.length >= 3) {
                    versionRegex = new RegExp(escaped, 'i');
                }
                
                if (searchTerm.length <= 2) {
                    // 1-2 characters: must match from start of module name
                    nameRegex = new RegExp('^' + escaped, 'i');
                } else {
                    // 3+ characters: search module name with word boundary
                    if (hasNumbers) {
                        // Contains numbers - match anywhere in name
                        nameRegex = new RegExp(escaped, 'i');
                    } else {
                        // Letters only - match from word boundary
                        nameRegex = new RegExp('(^|[\\/\\-])' + escaped, 'i');
                    }
                }
            }
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                // Category filter
                const rowCategory = row.getAttribute('data-category');
                const categoryMatch = !selectedCategory || rowCategory === selectedCategory;
                
                // Search filter
                let searchMatch = true;
                if (nameRegex || versionRegex) {
                    const nameCell = row.querySelector('td:first-child');
                    const versionsCell = row.querySelector('td:last-child');
                    
                    let nameMatch = false;
                    let versionMatch = false;
                    
                    // Check module name
                    if (nameRegex && nameCell) {
                        const moduleName = nameCell.textContent.trim().toLowerCase();
                        nameMatch = nameRegex.test(moduleName);
                    }
                    
                    // Check versions (if search contains numbers or is 3+ characters)
                    if (versionRegex && versionsCell) {
                        const versionsText = versionsCell.textContent.toLowerCase();
                        versionMatch = versionRegex.test(versionsText);
                    }
                    
                    // Match if either name or version matches
                    searchMatch = nameMatch || versionMatch;
                }
                
                // Show row if both filters match
                if (categoryMatch && searchMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update count (show filtered count if filtering, otherwise total)
            const countElement = document.getElementById('uniqueCount');
            if (countElement) {
                if (selectedCategory || searchTerm) {
                    countElement.textContent = visibleCount;
                } else {
                    countElement.textContent = allModules.length || rows.length;
                }
            }
        }
        
        // Search functionality with debouncing (300ms delay)
        if (searchInput) {
            const debouncedApplyFilters = debounce(applyFilters, 300);
            searchInput.addEventListener('input', function() {
                // Apply immediately for 1-2 character searches, debounce for longer
                if (this.value.length <= 2) {
                    applyFilters();
                } else {
                    debouncedApplyFilters();
                }
            });
        }
        
        // Category filter functionality
        if (categoryFilter) {
            categoryFilter.addEventListener('change', applyFilters);
        }
        function copyText(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            }
            return Promise.reject(new Error('Clipboard API not available'));
        }

        function attachCopyHandlers() {
            const buttons = document.querySelectorAll('.copy-version');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const version = btn.getAttribute('data-version');
                    if (!version) return;
                    copyText(`module load ${version}`)
                        .then(() => {
                            btn.classList.add('btn-success', 'text-white');
                            btn.classList.remove('btn-outline-secondary');
                            setTimeout(() => {
                                btn.classList.remove('btn-success', 'text-white');
                                btn.classList.add('btn-outline-secondary');
                            }, 1200);
                        })
                        .catch(err => {
                            console.error('Copy failed', err);
                        });
                });
            });
        }

        // Initial wiring for server-rendered modules
        attachCopyHandlers();
    });
})();
</script>
{% endblock %}
